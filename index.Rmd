---
title: "top 2000 vs top 50"
author: "Laurens de Vries"
date: "15/2/2021"
output: flexdashboard::flex_dashboard
---

```{r setup, include=FALSE}
library(tidyverse)
library(tidymodels)
library(spotifyr)
library(plotly)
library(compmus)
library(ggplot2)
library(dplyr)
library(ggthemes)
library(flexdashboard)
library(ggdendro)
library(heatmaply)


get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}  
```

Introduction
=========================================

DO NOT SHOW THIS PORTFOLIO IN CLASS

The Top 2000 is an annual Dutch marathon radio program, that plays the 2,000 most popular songs of all time determined by a public vote. The highest ranking songs do not vary much from year to year but there sometimes new songs. I am interested in if these new songs are similar to older high ranking songs compared to other popular songs from the same year. 

The new top 2000 songs probably have more focus on instruments compared to other hit songs from the same years.

As for the corpus I will be using a playlist of the 50 newest songs from the top 2000 and comparing to the spotify Dutch top 50 playlist.



The following graphs will compare the distribution of certain variables between the playlists.

Visualization  {.storyboard}
=========================================


```{r, include = FALSE}
top2000 <- get_playlist_audio_features("", "2oBIu2PZIRU8H1XnZXt0LJ")
top50 <- get_playlist_audio_features("", "0t20WVodhAy6RHa2yrMty8")

hits <-
  bind_rows(
    top2000 %>% mutate(playlist = "Top 2000"),
    top50 %>% mutate(playlist = "Top 50")
  )

hits_features <-
  hits %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>% 
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))

hits_recipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = hits_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].

hits_cv <- hits_features %>% vfold_cv(5)

knn_model <-
  nearest_neighbor(neighbors = 1) %>%
  set_mode("classification") %>% 
  set_engine("kknn")

hits_knn <- 
  workflow() %>% 
  add_recipe(hits_recipe) %>% 
  add_model(knn_model) %>% 
  fit_resamples(
    hits_cv, 
    control = control_resamples(save_pred = TRUE)
  )

```

### Classification of top 2000 and top 50

```{r}
hits_knn %>% get_conf_mat() %>% autoplot(type = "mosaic")

```

### Feature importance

```{r}

```


### Tempogram of Danny Vera - Rollercoaster

```{r}
# rolco <- get_tidy_audio_analysis("5B5YKjgne3TZzNpMsN9aj1")
# 
# rolco %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()
```

***

The tempogram of rollercoaster is very unclear, the song primarily features a guitar melody and vocals.
Tempograms seem to be more unclear on songs with these characteristics.

### Tempogram of Nathan Evans - Wellerman (Sea Shanty / 220 KID x Billen Ted Remix)

```{r}
# well <- get_tidy_audio_analysis("3iw6V4LH7yPj1ESORX9RIN")
# 
# well %>%
#   tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
#   ggplot(aes(x = time, y = bpm, fill = power)) +
#   geom_raster() +
#   scale_fill_viridis_c(guide = "none") +
#   labs(x = "Time (s)", y = "Tempo (BPM)") +
#   theme_classic()
```

*** 

The tempogram of wellerman is very clear, the tempo is very constant throughout the song. 
This is also the case for more songs in the top 50, the tempograms are clearer than most of the new songs from the top 2000.


### Structure of #1 songs of top 50 and top 2000

```{r}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )


rollercoaster <-
  get_tidy_audio_analysis("5B5YKjgne3TZzNpMsN9aj1") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

rollercoaster %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "aitchison",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  ggtitle("Danny Vera - Rollercoaster") +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")

wellerman <-
  get_tidy_audio_analysis("3iw6V4LH7yPj1ESORX9RIN") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

wellerman %>% 
  compmus_match_pitch_template(
    key_templates,         # Change to chord_templates if descired
    method = "aitchison",  # Try different distance metrics
    norm = "manhattan"     # Try different norms
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  ggtitle("Nathan Evans - Wellerman (Sea Shanty / 220 KID x Billen Ted Remix)") +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "")
```

***

The keygrams are less suited for showing the difference between these songs, 
spotify seperates wellerman in 5 sections making it difficult to deduce differences with such big intervals between the columns. Rollercoaster shows that the keys do not change a lot throughout the
song. Wellerman starts in B-flat major in the first section but the rest of the sections are not clear. Different distance methods also did not result to more visible patterns.


### Structure of #1 songs of top 50 and top 2000

```{r}
rollercoaster <-
  get_tidy_audio_analysis("5B5YKjgne3TZzNpMsN9aj1") %>% 
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"
      )
  )


wellerman <-
  get_tidy_audio_analysis("3iw6V4LH7yPj1ESORX9RIN") %>% 
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"
      )
  )



bind_rows(
  rollercoaster %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  rollercoaster %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  ggtitle("Danny Vera - Rollercoaster") +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")

bind_rows(
  wellerman %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  wellerman %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  ggtitle("Nathan Evans - Wellerman (Sea Shanty / 220 KID x Billen Ted Remix)") +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```

***

The differences between the songs are also visible on the self similairity matrices.
Rollercoaster results in a much more uniform plot, while the Sea Shanty, has yellow lines 
at around 30 and 80 seconds. This correlates when you listen to the songs, Sea Shanty can be classified as an EDM song with "drops". These drops result in a drastic change in timbre, rollercoaster is a pop song with more gradual timbre changes. Looking at the pitches, it is the same case the drops also result in big changes in pitch. 

### Chromagram of #1 song of top 2000
```{r}
rollercoaster2 <-
  get_tidy_audio_analysis("5B5YKjgne3TZzNpMsN9aj1") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

rollercoaster2 %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  ggtitle("Chromagram of Rollercoaster by Danny Vera") +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```

***

The chromagram shows that the song is written in the A pitch class. There is no 
overlap visible between the pitch classes. The melody is not clearly visible as the song is quite long with a short melody.

### Energy

```{r}
hits <-
  bind_rows(
    top2000 %>% mutate(category = "Top 2000"),
    top50 %>% mutate(category = "Top 50")
  )

violinPlot1 <- hits %>%
  ggplot(aes(x = category, y = energy)) +
  geom_violin()

ggplotly(violinPlot1)
```

### Acousticness

```{r}
violinPlot2 <- hits %>%
  ggplot(aes(x = category, y = acousticness)) +
  geom_violin()

ggplotly(violinPlot2)
```

### Valence

```{r}
violinPlot3 <- hits %>%
  ggplot(aes(x = category, y = valence)) +
  geom_violin()

ggplotly(violinPlot3)

```

Discussion
=========================================